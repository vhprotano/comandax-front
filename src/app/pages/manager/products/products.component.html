<div class="space-y-6">
  <div class="flex items-center justify-between">
    <h2 class="text-2xl font-bold text-gray-900">Gerenciar Produtos</h2>
    <button
      (click)="openForm()"
      class="px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors font-medium"
    >
      + Novo Produto
    </button>
  </div>

  <!-- Form Modal -->
  <div
    *ngIf="showForm"
    class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50"
  >
    <div class="bg-white rounded-lg shadow-lg p-6 max-w-md w-full mx-4">
      <h3 class="text-xl font-bold text-gray-900 mb-4">
        {{ editingId ? "Editar Produto" : "Novo Produto" }}
      </h3>

      <form [formGroup]="productForm" (ngSubmit)="onSubmit()" class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1"
            >Nome</label
          >
          <input
            type="text"
            formControlName="name"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500"
          />
        </div>

        <div>
          <!-- Switch para preço por peso -->
          <div class="flex items-center justify-between mt-2">
            <label class="block text-sm font-medium text-gray-700"
              >Preço por peso</label
            >
            <div class="relative inline-block w-12 h-6 cursor-pointer">
              <input
                type="checkbox"
                formControlName="isPricePerKg"
                class="absolute inset-0 w-full h-full opacity-0 cursor-pointer"
              />
              <div
                [class.bg-primary-600]="productForm.get('isPricePerKg')?.value"
                [class.bg-gray-300]="!productForm.get('isPricePerKg')?.value"
                class="w-12 h-6 rounded-full shadow-inner transition-colors duration-200 pointer-events-none"
              ></div>
              <div
                [class.translate-x-6]="productForm.get('isPricePerKg')?.value"
                [class.translate-x-0]="!productForm.get('isPricePerKg')?.value"
                class="absolute left-1 top-1 w-4 h-4 bg-white rounded-full shadow transition-transform duration-200 pointer-events-none"
              ></div>
            </div>
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">{{
            productForm.get("isPricePerKg")?.value ? "Preço (kg)" : "Preço"
          }}</label>
          <input
            type="number"
            formControlName="price"
            step="0.01"
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500"
          />
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1"
            >Categoria</label
          >
          <div class="relative">
            <input
              type="text"
              [(ngModel)]="categorySearch"
              [ngModelOptions]="{ standalone: true }"
              (focus)="showCategoryDropdown = true"
              (blur)="onCategoryInputBlur()"
              (input)="filterCategories()"
              placeholder="Buscar ou criar categoria..."
              class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500"
            />

            <!-- Dropdown -->
            @if (showCategoryDropdown) {
              <div
                class="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto"
              >
                <button
                  type="button"
                  *ngFor="let category of filteredCategories"
                  (mousedown)="selectCategory(category)"
                  class="w-full px-3 py-2 text-left hover:bg-gray-100 transition-colors flex items-center gap-2"
                >
                  <span [innerHTML]="category.icon"></span>
                  <span>{{ category.name }}</span>
                </button>

                <!-- Opção de criar nova categoria -->
                <button
                  type="button"
                  *ngIf="shouldShowCreateOption()"
                  (mousedown)="createNewCategory()"
                  class="w-full px-3 py-2 text-left hover:bg-primary-50 transition-colors text-primary-600 font-medium border-t border-gray-200"
                >
                  <lucide-angular [img]="Plus"></lucide-angular> Adicionar
                  Categoria "{{ categorySearch }}"
                </button>

                <div
                  *ngIf="
                    filteredCategories.length === 0 && !shouldShowCreateOption()
                  "
                  class="px-3 py-2 text-gray-500 text-sm"
                >
                  Nenhuma categoria encontrada
                </div>
              </div>
            }
          </div>

          <!-- Selected Category Display -->
          <div
            *ngIf="selectedCategoryName"
            class="mt-2 px-3 py-2 bg-primary-50 rounded-lg flex items-center justify-between"
          >
            <span class="text-sm text-primary-700">
              <span [innerHTML]="selectedCategoryIcon"></span>
              {{ selectedCategoryName }}
            </span>
            <button
              type="button"
              (click)="clearCategory()"
              class="text-primary-600 hover:text-primary-700"
            >
              ✕
            </button>
          </div>
        </div>

        <div class="flex gap-2 pt-4">
          <button
            type="submit"
            class="flex-1 px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors font-medium"
          >
            {{ editingId ? "Atualizar" : "Criar" }}
          </button>
          <button
            type="button"
            (click)="closeForm()"
            class="flex-1 px-4 py-2 bg-gray-200 text-gray-900 rounded-lg hover:bg-gray-300 transition-colors font-medium"
          >
            Cancelar
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Products Table -->
  <div
    class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden"
  >
    <table class="w-full">
      <thead class="bg-gray-50 border-b border-gray-200">
        <tr>
          <th class="px-6 py-3 text-left text-sm font-semibold text-gray-900">
            Nome
          </th>
          <th class="px-6 py-3 text-left text-sm font-semibold text-gray-900">
            Preço
          </th>
          <th
            class="px-6 py-3 text-left text-sm font-semibold text-gray-900 d-none d-md-block"
          >
            Categoria
          </th>
          <th class="px-6 py-3 text-left text-sm font-semibold text-gray-900">
            Ações
          </th>
        </tr>
      </thead>
      <tbody class="divide-y divide-gray-200">
        <tr
          *ngFor="let product of products"
          class="hover:bg-gray-50 transition-colors"
        >
          <td class="px-6 py-4 text-sm text-gray-900">{{ product.name }}</td>
          <td class="px-6 py-4 text-sm text-gray-900">
            R$ {{ product.price.toFixed(2)
            }}{{ product.isPricePerKg ? "/kg" : "" }}
          </td>
          <td class="px-6 py-4 text-sm text-gray-600 d-none d-md-block">
            <span
              class="px-2 py-1 bg-primary-100 text-primary-700 rounded text-xs font-medium"
            >
              {{ getCategoryName(product.category_id) }}
            </span>
          </td>
          <td class="px-6 py-4 text-sm space-x-2">
            <div class="d-flex flex-column flex-md-row gap-1">
              <button
                (click)="editProduct(product)"
                class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors text-xs font-medium"
              >
                Editar
              </button>
              <button
                (click)="deleteProduct(product.id)"
                class="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700 transition-colors text-xs font-medium"
              >
                Deletar
              </button>
            </div>
          </td>
        </tr>
      </tbody>
    </table>

    <div *ngIf="products && products.length === 0" class="p-12 text-center">
      <p class="text-gray-600 text-lg">Nenhum produto cadastrado</p>
    </div>
  </div>
</div>
