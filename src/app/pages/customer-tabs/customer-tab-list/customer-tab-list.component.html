<div class="customer-tab-container">
  <!-- Header with Toggle -->
  <div class="header-section">
    <h1 class="page-title">Comandas</h1>

    <!-- Toggle Abertas/Fechadas -->
    <div class="toggle-container">
      <span class="toggle-label">
        {{ showClosedTabs ? "Fechadas" : "Abertas" }}
      </span>
      <button (click)="showClosedTabs = !showClosedTabs" [class.active]="!showClosedTabs" class="toggle-switch">
        <span class="toggle-slider" [class.checked]="!showClosedTabs"></span>
      </button>
    </div>
  </div>

  <!-- Loading State -->
  @if (isLoadingTabs) {
  <div class="loading-overlay">
    <div class="loading-content">
      <div class="notepad-animation">
        <div class="notepad">
          <div class="notepad-header"></div>
          <div class="notepad-lines">
            <div class="line line-1"></div>
            <div class="line line-2"></div>
            <div class="line line-3"></div>
            <div class="line line-4"></div>
          </div>
          <div class="pen">‚úèÔ∏è</div>
        </div>
      </div>
      <div class="loading-text-container">
        <p class="loading-title">Carregando comandas</p>
        <div class="loading-dots">
          <span></span>
          <span></span>
          <span></span>
        </div>
      </div>
    </div>
  </div>
  }

  <!-- Desktop Action Buttons -->
  <div class="desktop-actions">
    <button class="btn btn-primary" (click)="createNewComanda()">
      <lucide-angular [img]="Plus"></lucide-angular> Nova Comanda
    </button>
    <button class="btn btn-secondary" (click)="createNewPedido()">
      üìù Novo Pedido
    </button>
  </div>

  <!-- Comandas Abertas -->
  <div *ngIf="!showClosedTabs" class="customer-tab-section">
    <div class="customer-tab-grid">
      <div *ngFor="let tab of openedTabs" (click)="openTab(tab)" class="customer-tab-card">
        <div class="card-header">
          <div class="card-title-section">
            <h3 class="card-title">{{ tab.customer_name }}</h3>
            <span class="card-subtitle" *ngIf="tab.table_number">
              Mesa {{ tab.table_number }}
            </span>
          </div>
          <div class="card-header-actions">
            <span class="status-badge status-open">{{
              tab.status === "CLOSED" ? "Fechada" : "Aberta"
              }}</span>
            <button class="btn-delete-icon" (click)="deleteComanda(tab, $event)" ngbTooltip="Excluir comanda"
              placement="left">
              <lucide-angular [img]="Trash2" [size]="18"></lucide-angular>
            </button>
          </div>
        </div>

        <div class="card-body">
          <div class="items-list">
            <div *ngFor="let item of getDisplayItems(tab)" class="item-row">
              <span *ngIf="!item.isPricePerKg" class="item-quantity">{{ item?.quantity }}x</span>
              <span *ngIf="item.isPricePerKg" class="item-quantity">{{ item?.quantity }} kg</span>
              <span class="item-name">{{ item?.product_name }}</span>
              <span class="item-name text-end">R$ {{ item?.totalPrice }}</span>
            </div>
            <div *ngIf="hasMoreItems(tab)" class="more-items">
              +{{ getRemainingItemsCount(tab) }} item(s)...
            </div>
          </div>
        </div>

        <div class="card-footer">
          <span class="total-label">Total:</span>
          <span class="total-value">R$ {{ tab.total_price.toFixed(2) }}</span>
        </div>

        <!-- Action Buttons -->
        <div class="card-actions flex-column flex-sm-row">
          <button (click)="$event.stopPropagation(); openAddItemsModal(tab, $event)"
            class="action-btn action-btn-secondary">
            <lucide-angular [img]="Plus"></lucide-angular> Adicionar Itens
          </button>
          <button (click)="closeTabAction(tab, $event)" class="action-btn action-btn-success">
            ‚úîÔ∏è Fechar Comanda
          </button>
        </div>
      </div>

      <!-- Empty State -->
      <div *ngIf="(!openedTabs || openedTabs.length === 0) && !isLoadingTabs" class="empty-state">
        <div class="empty-icon">üìã</div>
        <p class="empty-title">Nenhuma comanda aberta</p>
        <p class="empty-subtitle">Crie uma nova comanda para come√ßar</p>
      </div>
    </div>
  </div>

  <!-- Comandas Fechadas -->
  <div *ngIf="showClosedTabs" class="customer-tab-section">
    <div class="customer-tab-grid">
      <div *ngFor="let tab of closedTabs" (click)="openTab(tab)" class="customer-tab-card">
        <div class="card-header">
          <div class="card-title-section">
            <h3 class="card-title">{{ tab.customer_name }}</h3>
            <span class="card-subtitle" *ngIf="tab.table_number">
              Mesa {{ tab.table_number }}
            </span>
          </div>
          <div class="card-header-actions">
            <span class="status-badge status-closed">Fechada</span>
            <button class="btn-delete-icon" (click)="deleteComanda(tab, $event)" ngbTooltip="Excluir comanda"
              placement="left">
              <lucide-angular [img]="Trash2" [size]="18"></lucide-angular>
            </button>
          </div>
        </div>

        <div class="card-body">
          <div class="items-list">
            <div *ngFor="let item of getDisplayItems(tab)" class="item-row">
              <span *ngIf="!item.isPricePerKg" class="item-quantity">{{ item?.quantity }}x</span>
              <span *ngIf="item.isPricePerKg" class="item-quantity">{{ item?.quantity }} kg</span>
              <span class="item-name">{{ item?.product_name }}</span>
            </div>
            <div *ngIf="hasMoreItems(tab)" class="more-items">
              +{{ getRemainingItemsCount(tab) }} item(s)...
            </div>
          </div>
        </div>

        <div class="card-footer">
          <span class="total-label">Total:</span>
          <span class="total-value">R$ {{ tab.total_price.toFixed(2) }}</span>
        </div>
      </div>

      <!-- Empty State -->
      <div *ngIf="!closedTabs || closedTabs.length === 0" class="empty-state">
        <div class="empty-icon">üìú</div>
        <p class="empty-title">Nenhuma comanda fechada</p>
      </div>
    </div>
  </div>

  <!-- Float Action Button (Mobile) - Expandable -->
  <div class="fab-container">
    <!-- FAB Options (appear when expanded) -->
    <div class="fab-options" [class.fab-options-visible]="fabExpanded">
      <button class="fab-option" (click)="createNewPedido()" title="Novo Pedido">
        <span class="fab-option-icon">üìù</span>
        <span class="fab-option-label">Pedido</span>
      </button>
      <button class="fab-option" (click)="createNewComanda()" title="Nova Comanda">
        <span class="fab-option-icon">üçΩÔ∏è</span>
        <span class="fab-option-label">Comanda</span>
      </button>
    </div>

    <!-- Main FAB Button -->
    <button class="fab fab-main" [class.fab-expanded]="fabExpanded" (click)="toggleFab()" title="Menu">
      <span class="fab-icon fab-icon-plus" [class.fab-icon-hidden]="fabExpanded"><lucide-angular
          [img]="Plus"></lucide-angular></span>
      <span class="fab-icon fab-icon-close" [class.fab-icon-visible]="fabExpanded">‚úï</span>
    </button>

    <!-- Backdrop (appears when expanded) -->
    <!-- <div
      class="fab-backdrop"
      [class.fab-backdrop-visible]="fabExpanded"
      (click)="toggleFab()"
    ></div> -->
  </div>
</div>

<!-- Modal Desktop: Detalhes da Comanda -->
<div *ngIf="selectedTab && !showAddItemsModal" class="modal-overlay modal-desktop-only" (click)="closeOrderDetail()">
  <div class="modal-content modal-large" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2 class="modal-title">Comanda - {{ selectedTab.customer_name }}</h2>
      <button class="modal-close" (click)="closeOrderDetail()">‚úï</button>
    </div>

    <div class="modal-body">
      <div class="order-info">
        <div class="info-row">
          <span class="info-label">Mesa:</span>
          <span class="info-value">{{
            selectedTab.table_number || "Sem mesa"
            }}</span>
        </div>
        <div class="info-row">
          <span class="info-label">Status:</span>
          <span class="status-badge" [class.status-open]="selectedTab.status === 'OPEN'"
            [class.status-closed]="selectedTab.status === 'CLOSED'">
            {{ selectedTab.status === "OPEN" ? "Aberta" : "Fechada" }}
          </span>
        </div>
      </div>

      <div class="items-section">
        <h3 class="section-title">Itens</h3>
        <div class="items-table">
          <div *ngFor="let order of selectedTab.orders" class="order-group">
            <div class="order-header">
              <span class="order-label">Pedido</span>
              <button class="btn-delete-icon-small" (click)="deleteOrder(order.id, $event)" ngbTooltip="Excluir pedido"
                placement="left">
                <lucide-angular [img]="Trash2" [size]="16"></lucide-angular>
              </button>
            </div>
            <div *ngFor="let item of order.products" class="table-row">
              <span *ngIf="!item.isPricePerKg" class="item-qty">{{ item?.quantity }}x</span>
              <span *ngIf="item.isPricePerKg" class="item-qty">{{ item?.quantity }} kg</span>
              <span class="item-name">{{ item?.product_name }}</span>
              <span class="item-price">R$
                {{
                ((item?.quantity || 0) * (item?.unit_price || 0)).toFixed(2)
                }}</span>
            </div>
          </div>
        </div>
      </div>

      <div class="order-total">
        <span class="total-label">Total:</span>
        <span class="total-value">R$ {{ selectedTab.total_price.toFixed(2) }}</span>
      </div>
    </div>

    <div class="modal-footer" *ngIf="selectedTab.status === 'OPEN'">
      <button class="btn btn-secondary" (click)="
          $event.stopPropagation(); openAddItemsModal(selectedTab, $event)
        ">
        <lucide-angular [img]="Plus"></lucide-angular> Adicionar Itens
      </button>
      <button class="btn btn-success" (click)="closeTabAction(selectedTab, $event)">
        ‚úîÔ∏è Fechar Comanda
      </button>
    </div>
  </div>
</div>

<!-- Offcanvas Template: Detalhes da Comanda -->
<ng-template #orderDetailOffcanvas let-offcanvas>
  <div class="offcanvas-header">
    <h2 class="offcanvas-title">{{ selectedTab?.customer_name }}</h2>
    <button type="button" class="btn-close" (click)="closeOrderDetail()"></button>
  </div>
  <div class="offcanvas-body">
    <div class="order-info" *ngIf="selectedTab">
      <div class="info-row">
        <span class="info-label">Mesa:</span>
        <span class="info-value">{{
          selectedTab.table_number || "Sem mesa"
          }}</span>
      </div>
      <div class="info-row">
        <span class="info-label">Status:</span>
        <span class="status-badge" [class.status-open]="selectedTab.status === 'OPEN'"
          [class.status-closed]="selectedTab.status === 'CLOSED'">
          {{ selectedTab.status === "OPEN" ? "Aberta" : "Fechada" }}
        </span>
      </div>
    </div>

    <div class="items-section" *ngIf="selectedTab">
      <h3 class="section-title">Itens</h3>
      <div class="items-table">
        <div *ngFor="let order of selectedTab.orders">
          <div *ngFor="let item of order.products" class="table-row">
            <span *ngIf="!item.isPricePerKg" class="item-qty">{{ item?.quantity }}x</span>
            <span *ngIf="item.isPricePerKg" class="item-qty">{{ item?.quantity }} kg</span>
            <span class="item-name">{{ item?.product_name }}</span>
            <span class="item-price">R$
              {{
              ((item?.quantity || 0) * (item?.unit_price || 0)).toFixed(2)
              }}</span>
          </div>
        </div>
      </div>
    </div>

    <div class="order-total" *ngIf="selectedTab">
      <span class="total-label">Total:</span>
      <span class="total-value">R$ {{ selectedTab.total_price.toFixed(2) }}</span>
    </div>

    <div class="offcanvas-actions" *ngIf="selectedTab && selectedTab.status === 'OPEN'">
      <button class="btn btn-secondary btn-block" (click)="
          $event.stopPropagation(); openAddItemsModal(selectedTab, $event)
        ">
        <lucide-angular [img]="Plus"></lucide-angular> Adicionar Itens
      </button>
      <button class="btn btn-success btn-block" (click)="closeTabAction(selectedTab, $event)">
        ‚úîÔ∏è Fechar Comanda
      </button>
    </div>
  </div>
</ng-template>

<!-- Modal Desktop: Adicionar Itens -->
<div *ngIf="showAddItemsModal" class="modal-overlay modal-desktop-only" (click)="closeAddItemsModal()">
  <div class="modal-content modal-xlarge" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2 class="modal-title">
        Adicionar Itens - {{ selectedTab?.customer_name }}
      </h2>
      <button class="modal-close" (click)="closeAddItemsModal()">‚úï</button>
    </div>

    <div class="modal-body modal-body-flex">
      <!-- Products Section -->
      <div class="products-section">
        <!-- Categories -->
        <div class="categories-filter">
          <button (click)="selectedCategory = ''" [class.active]="selectedCategory === ''" class="category-btn">
            Todos
          </button>
          <button *ngFor="let category of categories" (click)="selectedCategory = category.id"
            [class.active]="selectedCategory === category.id" class="category-btn">
            <span [innerHTML]="category.icon"></span>
            {{ category.name }}
          </button>
        </div>

        <!-- Products Grid -->
        <div class="products-grid">
          <div *ngFor="let product of getFilteredProducts()" [attr.data-product-id]="product.id"
            (click)="addToCart(product)" class="product-card">
            <h4 class="product-name">{{ product.name }}</h4>
            <p class="product-price">
              R$ {{ product.price.toFixed(2)
              }}{{ product.isPricePerKg ? "/kg" : "" }}
            </p>
          </div>

          <div *ngIf="getFilteredProducts().length === 0" class="empty-products">
            <p>Nenhum produto encontrado</p>
          </div>
        </div>
      </div>

      <!-- Cart Section -->
      <div class="cart-section">
        <h3 class="cart-title">Carrinho</h3>

        <div *ngIf="cartItems.length === 0" class="empty-cart">
          <div class="empty-cart-icon">üõí</div>
          <p class="empty-cart-text">Carrinho vazio</p>
        </div>

        <div *ngIf="cartItems.length > 0" class="cart-items">
          <div *ngFor="let item of cartItems" class="cart-item">
            <div class="item-info">
              <h4 class="item-name">{{ item.product_name }}</h4>
              <p class="item-price">
                R$ {{ item.unit_price.toFixed(2)
                }}{{ item.isPricePerKg ? "/kg" : "" }}
              </p>
            </div>
            <div class="item-controls">
              <ng-container *ngIf="item?.isPricePerKg">
                <div class="per-kg-inputs">
                  <input type="text" mask="separator.2" thousandSeparator="," decimalMarker="." suffix=" kg"
                    [(ngModel)]="item.quantity" (ngModelChange)="onWeightChange(item, $event)"
                    class="form-control qty-input" placeholder="Peso" />
                  <input type="text" mask="separator.2" thousandSeparator="," decimalMarker="." prefix="R$ "
                    [ngModel]="item.unit_price * item.quantity" (ngModelChange)="onPriceChange(item, $event)"
                    class="form-control qty-input" placeholder="Pre√ßo" />
                </div>
                <button class="qty-btn last-item" (click)="removeFromCart(item.id)">
                  üóëÔ∏è
                </button>
              </ng-container>
              <ng-container *ngIf="item?.isPricePerKg == false">
                <button [ngClass]="{
                    'qty-btn': true,
                    'last-item': item.quantity === 1,
                  }" (click)="decreaseQuantity(item)">
                  ‚àí
                </button>
                <span class="qty-display">{{ item.quantity }}</span>
                <button class="qty-btn" (click)="increaseQuantity(item)">
                  +
                </button>
              </ng-container>
            </div>
          </div>
        </div>

        <div *ngIf="cartItems.length > 0" class="cart-footer">
          <div class="cart-total">
            <span class="total-label">Total:</span>
            <span class="total-value">R$ {{ cartTotal.toFixed(2) }}</span>
          </div>
          <button (click)="submitAddItems()" class="submit-btn">
            Adicionar √† Comanda
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Offcanvas Template: Adicionar Itens -->
<ng-template #addItemsOffcanvas let-offcanvas>
  <div class="offcanvas-header">
    <h2 class="offcanvas-title">Adicionar Itens</h2>
    <button type="button" class="btn-close" (click)="closeAddItemsModal()"></button>
  </div>
  <div class="offcanvas-body offcanvas-add-items">
    <!-- Categories with Navigation -->
    <div class="categories-wrapper-mobile">
      <div class="categories-filter-mobile" #categoriesContainerMobile>
        <button (click)="selectedCategory = ''" [class.active]="selectedCategory === ''" class="category-btn">
          Todos
        </button>
        <button *ngFor="let category of categories" (click)="selectedCategory = category.id"
          [class.active]="selectedCategory === category.id" class="category-btn">
          <span [innerHTML]="category.icon"></span>
          {{ category.name }}
        </button>
      </div>
    </div>

    <!-- Products Grid -->
    <div class="products-grid-mobile">
      <div *ngFor="let product of getFilteredProducts()" [attr.data-product-id]="product.id"
        (click)="addToCart(product)" class="product-card">
        <h4 class="product-name">{{ product.name }}</h4>
        <p class="product-price">R$ {{ product.price.toFixed(2) }}{{ product.isPricePerKg ? '/kg' : '' }}</p>
      </div>

      <div *ngIf="getFilteredProducts().length === 0" class="empty-products">
        <p>Nenhum produto encontrado</p>
      </div>
    </div>

    <!-- Cart Fixed Bottom -->
    <div class="cart-fixed-bottom" *ngIf="cartItems.length > 0">
      <div class="cart-items-compact">
        <div *ngFor="let item of cartItems" class="cart-item-compact" [ngClass]="{'align-items-baseline flex-column': item?.isPricePerKg}">
          <span class="item-name">{{ item.product_name }}</span>
          <div class="item-controls">
          <ng-container *ngIf="item?.isPricePerKg">
            <button class="qty-btn last-item" (click)="removeFromCart(item.id)">
              üóëÔ∏è
            </button>
            <div class="per-kg-inputs">
              <input type="text" mask="separator.2" thousandSeparator="," decimalMarker="." suffix=" kg"
                [(ngModel)]="item.quantity" (ngModelChange)="onWeightChange(item, $event)"
                class="form-control qty-input" placeholder="Peso" />
              <input type="text" mask="separator.2" thousandSeparator="," decimalMarker="." prefix="R$ "
                [ngModel]="item.unit_price * item.quantity" (ngModelChange)="onPriceChange(item, $event)"
                class="form-control qty-input" placeholder="Pre√ßo" />
            </div>
          </ng-container>
          <ng-container *ngIf="!item?.isPricePerKg">
            <button class="qty-btn" (click)="decreaseQuantity(item)" >‚àí</button>
            <span class="qty-display">{{ item.quantity }}</span>
            <button class="qty-btn" (click)="increaseQuantity(item)" >+</button>
          </ng-container>
        </div>
          <span class="item-total">R$
            {{
            ((item?.quantity || 0) * (item?.unit_price || 0)).toFixed(2)
            }}</span>
        </div>
      </div>
      <div class="cart-footer-mobile">
        <div class="cart-total">
          <span class="total-label">Total:</span>
          <span class="total-value">R$ {{ cartTotal.toFixed(2) }}</span>
        </div>
        <button (click)="submitAddItems()" class="submit-btn">
          Adicionar √† Comanda
        </button>
      </div>
    </div>
  </div>
</ng-template>

<!-- Receipt Component -->
<app-receipt *ngIf="selectedTabForReceipt" [tab]="selectedTabForReceipt" (close)="onReceiptClose()"
  (finalize)="finalizeOrder($event)" (sendEmail)="onReceiptSendEmail()"></app-receipt>