<div class="comandas-container">
  <!-- Header with Toggle -->
  <div class="header-section">
    <h1 class="page-title">Comandas</h1>
    
    <!-- Toggle Abertas/Fechadas -->
    <div class="toggle-container">
      <span class="toggle-label">
        {{ showClosedOrders ? 'Fechadas' : 'Abertas' }}
      </span>
      <button
        (click)="showClosedOrders = !showClosedOrders"
        [class.active]="!showClosedOrders"
        class="toggle-switch"
      >
        <span class="toggle-slider" [class.checked]="!showClosedOrders"></span>
      </button>
    </div>
  </div>

  
  <!-- Desktop Action Buttons -->
  <div class="desktop-actions">
    <button class="btn btn-primary" (click)="createNewComanda()">
      <lucide-angular [img]="Plus"></lucide-angular> Nova Comanda
    </button>
    <button class="btn btn-secondary" (click)="createNewPedido()">
      üìù Novo Pedido
    </button>
  </div>

  <!-- Comandas Abertas -->
  <div *ngIf="!showClosedOrders" class="comandas-section">
    <div class="comandas-grid">
      <div
        *ngFor="let order of orders"
        (click)="openOrder(order)"
        class="comanda-card"
      >
        <div class="card-header">
          <div class="card-title-section">
            <h3 class="card-title">{{ order.customer_name }}</h3>
            <span class="card-subtitle" *ngIf="order.table_number">
              {{ order.table_number }}
            </span>
          </div>
          <span class="status-badge status-open">Aberta</span>
        </div>

        <div class="card-body">
          <div class="items-list">
            <div *ngFor="let item of getDisplayItems(order)" class="item-row">
              <span class="item-quantity">{{ item.quantity }}x</span>
              <span class="item-name">{{ item.product_name }}</span>
            </div>
            <div *ngIf="hasMoreItems(order)" class="more-items">
              +{{ getRemainingItemsCount(order) }} item(s)...
            </div>
          </div>
        </div>

        <div class="card-footer">
          <span class="total-label">Total:</span>
          <span class="total-value">R$ {{ order.total_price.toFixed(2) }}</span>
        </div>

        <!-- Action Buttons -->
        <div class="card-actions flex-column flex-sm-row">
          <button
            (click)="openAddItemsModal(order, $event)"
            class="action-btn action-btn-secondary"
          >
            <lucide-angular [img]="Plus"></lucide-angular> Adicionar Itens
          </button>
          <button
            (click)="closeOrderAction(order, $event)"
            class="action-btn action-btn-success"
          >
            ‚úîÔ∏è Fechar Comanda
          </button>
        </div>
      </div>

      <!-- Empty State -->
      <div *ngIf="orders.length === 0" class="empty-state">
        <div class="empty-icon">üìã</div>
        <p class="empty-title">Nenhuma comanda aberta</p>
        <p class="empty-subtitle">Crie uma nova comanda para come√ßar</p>
      </div>
    </div>
  </div>

  <!-- Comandas Fechadas -->
  <div *ngIf="showClosedOrders" class="comandas-section">
    <div class="comandas-grid">
      <div
        *ngFor="let order of closedOrders"
        (click)="openOrder(order)"
        class="comanda-card"
      >
        <div class="card-header">
          <div class="card-title-section">
            <h3 class="card-title">{{ order.customer_name }}</h3>
            <span class="card-subtitle" *ngIf="order.table_number">
              {{ order.table_number }}
            </span>
          </div>
          <span class="status-badge status-closed">Fechada</span>
        </div>

        <div class="card-body">
          <div class="items-list">
            <div *ngFor="let item of getDisplayItems(order)" class="item-row">
              <span class="item-quantity">{{ item.quantity }}x</span>
              <span class="item-name">{{ item.product_name }}</span>
            </div>
            <div *ngIf="hasMoreItems(order)" class="more-items">
              +{{ getRemainingItemsCount(order) }} item(s)...
            </div>
          </div>
        </div>

        <div class="card-footer">
          <span class="total-label">Total:</span>
          <span class="total-value">R$ {{ order.total_price.toFixed(2) }}</span>
        </div>
      </div>

      <!-- Empty State -->
      <div *ngIf="closedOrders.length === 0" class="empty-state">
        <div class="empty-icon">üìú</div>
        <p class="empty-title">Nenhuma comanda fechada</p>
      </div>
    </div>
  </div>

  <!-- Float Action Button (Mobile) - Expandable -->
  <div class="fab-container">
    <!-- FAB Options (appear when expanded) -->
    <div class="fab-options" [class.fab-options-visible]="fabExpanded">
      <button class="fab-option" (click)="createNewPedido()" title="Novo Pedido">
        <span class="fab-option-icon">üìù</span>
        <span class="fab-option-label">Pedido</span>
      </button>
      <button class="fab-option" (click)="createNewComanda()" title="Nova Comanda">
        <span class="fab-option-icon">üçΩÔ∏è</span>
        <span class="fab-option-label">Comanda</span>
      </button>
    </div>

    <!-- Main FAB Button -->
    <button
      class="fab fab-main"
      [class.fab-expanded]="fabExpanded"
      (click)="toggleFab()"
      title="Menu"
    >
      <span class="fab-icon fab-icon-plus" [class.fab-icon-hidden]="fabExpanded"><lucide-angular [img]="Plus"></lucide-angular></span>
      <span class="fab-icon fab-icon-close" [class.fab-icon-visible]="fabExpanded">‚úï</span>
    </button>

    <!-- Backdrop (appears when expanded) -->
    <!-- <div
      class="fab-backdrop"
      [class.fab-backdrop-visible]="fabExpanded"
      (click)="toggleFab()"
    ></div> -->
  </div>

</div>

<!-- Modal Desktop: Detalhes da Comanda -->
<div *ngIf="selectedOrder && !showAddItemsModal" class="modal-overlay modal-desktop-only" (click)="closeOrderDetail()">
  <div class="modal-content modal-large" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2 class="modal-title">Comanda - {{ selectedOrder.customer_name }}</h2>
      <button class="modal-close" (click)="closeOrderDetail()">‚úï</button>
    </div>

    <div class="modal-body">
      <div class="order-info">
        <div class="info-row">
          <span class="info-label">Mesa:</span>
          <span class="info-value">{{ selectedOrder.table_number || 'Sem mesa' }}</span>
        </div>
        <div class="info-row">
          <span class="info-label">Status:</span>
          <span class="status-badge" [class.status-open]="selectedOrder.status === 'open'" [class.status-closed]="selectedOrder.status === 'closed'">
            {{ selectedOrder.status === 'open' ? 'Aberta' : 'Fechada' }}
          </span>
        </div>
      </div>

      <div class="items-section">
        <h3 class="section-title">Itens</h3>
        <div class="items-table">
          <div *ngFor="let item of selectedOrder.items" class="table-row">
            <span class="item-qty">{{ item.quantity }}x</span>
            <span class="item-name">{{ item.product_name }}</span>
            <span class="item-price">R$ {{ (item.quantity * item.unit_price).toFixed(2) }}</span>
          </div>
        </div>
      </div>

      <div class="order-total">
        <span class="total-label">Total:</span>
        <span class="total-value">R$ {{ selectedOrder.total_price.toFixed(2) }}</span>
      </div>
    </div>

    <div class="modal-footer" *ngIf="selectedOrder.status === 'open'">
      <button class="btn btn-secondary" (click)="openAddItemsModal(selectedOrder, $event)">
        <lucide-angular [img]="Plus"></lucide-angular> Adicionar Itens
      </button>
      <button class="btn btn-success" (click)="closeOrderAction(selectedOrder, $event)">
        ‚úîÔ∏è Fechar Comanda
      </button>
    </div>
  </div>
</div>

<!-- Offcanvas Template: Detalhes da Comanda -->
<ng-template #orderDetailOffcanvas let-offcanvas>
  <div class="offcanvas-header">
    <h2 class="offcanvas-title">{{ selectedOrder?.customer_name }}</h2>
    <button type="button" class="btn-close" (click)="closeOrderDetail()"></button>
  </div>
  <div class="offcanvas-body">
    <div class="order-info" *ngIf="selectedOrder">
      <div class="info-row">
        <span class="info-label">Mesa:</span>
        <span class="info-value">{{ selectedOrder.table_number || 'Sem mesa' }}</span>
      </div>
      <div class="info-row">
        <span class="info-label">Status:</span>
        <span class="status-badge" [class.status-open]="selectedOrder.status === 'open'" [class.status-closed]="selectedOrder.status === 'closed'">
          {{ selectedOrder.status === 'open' ? 'Aberta' : 'Fechada' }}
        </span>
      </div>
    </div>

    <div class="items-section" *ngIf="selectedOrder">
      <h3 class="section-title">Itens</h3>
      <div class="items-table">
        <div *ngFor="let item of selectedOrder.items" class="table-row">
          <span class="item-qty">{{ item.quantity }}x</span>
          <span class="item-name">{{ item.product_name }}</span>
          <span class="item-price">R$ {{ (item.quantity * item.unit_price).toFixed(2) }}</span>
        </div>
      </div>
    </div>

    <div class="order-total" *ngIf="selectedOrder">
      <span class="total-label">Total:</span>
      <span class="total-value">R$ {{ selectedOrder.total_price.toFixed(2) }}</span>
    </div>

    <div class="offcanvas-actions" *ngIf="selectedOrder && selectedOrder.status === 'open'">
      <button class="btn btn-secondary btn-block" (click)="openAddItemsModal(selectedOrder, $event)">
        <lucide-angular [img]="Plus"></lucide-angular> Adicionar Itens
      </button>
      <button class="btn btn-success btn-block" (click)="closeOrderAction(selectedOrder, $event)">
        ‚úîÔ∏è Fechar Comanda
      </button>
    </div>
  </div>
</ng-template>

<!-- Modal Desktop: Adicionar Itens -->
<div *ngIf="showAddItemsModal" class="modal-overlay modal-desktop-only" (click)="closeAddItemsModal()">
  <div class="modal-content modal-xlarge" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2 class="modal-title">Adicionar Itens - {{ selectedOrder?.customer_name }}</h2>
      <button class="modal-close" (click)="closeAddItemsModal()">‚úï</button>
    </div>

    <div class="modal-body modal-body-flex">
      <!-- Products Section -->
      <div class="products-section">
        <!-- Categories -->
        <div class="categories-filter">
          <button
            (click)="selectedCategory = ''"
            [class.active]="selectedCategory === ''"
            class="category-btn"
          >
            Todos
          </button>
          <button
            *ngFor="let category of categories"
            (click)="selectedCategory = category.id"
            [class.active]="selectedCategory === category.id"
            class="category-btn"
          >
            <span [innerHTML]="category.icon"></span>
            {{ category.name }}
          </button>
        </div>

        <!-- Products Grid -->
        <div class="products-grid">
          <div
            *ngFor="let product of getFilteredProducts()"
            [attr.data-product-id]="product.id"
            (click)="addToCart(product)"
            class="product-card"
          >
            <h4 class="product-name">{{ product.name }}</h4>
            <p class="product-price">R$ {{ product.price.toFixed(2) }}</p>
          </div>

          <div *ngIf="getFilteredProducts().length === 0" class="empty-products">
            <p>Nenhum produto encontrado</p>
          </div>
        </div>
      </div>

      <!-- Cart Section -->
      <div class="cart-section">
        <h3 class="cart-title">Carrinho</h3>

        <div *ngIf="cartItems.length === 0" class="empty-cart">
          <div class="empty-cart-icon">üõí</div>
          <p class="empty-cart-text">Carrinho vazio</p>
        </div>

        <div *ngIf="cartItems.length > 0" class="cart-items">
          <div *ngFor="let item of cartItems" class="cart-item">
            <div class="item-info">
              <h4 class="item-name">{{ item.product_name }}</h4>
              <p class="item-price">R$ {{ item.unit_price.toFixed(2) }}</p>
            </div>
            <div class="item-controls">
              <button (click)="decreaseQuantity(item)" class="qty-btn">‚àí</button>
              <span class="qty-display">{{ item.quantity }}</span>
              <button (click)="increaseQuantity(item)" class="qty-btn">+</button>
            </div>
          </div>
        </div>

        <div *ngIf="cartItems.length > 0" class="cart-footer">
          <div class="cart-total">
            <span class="total-label">Total:</span>
            <span class="total-value">R$ {{ cartTotal.toFixed(2) }}</span>
          </div>
          <button (click)="submitAddItems()" class="submit-btn">
            Adicionar √† Comanda
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Offcanvas Template: Adicionar Itens -->
<ng-template #addItemsOffcanvas let-offcanvas>
  <div class="offcanvas-header">
    <h2 class="offcanvas-title">Adicionar Itens</h2>
    <button type="button" class="btn-close" (click)="closeAddItemsModal()"></button>
  </div>
  <div class="offcanvas-body offcanvas-add-items">
    <!-- Categories with Navigation -->
    <div class="categories-wrapper-mobile">
      <button
        class="category-scroll-btn-mobile category-scroll-left-mobile"
        (click)="scrollCategoriesMobile('left')"
        [disabled]="!canScrollLeftMobile"
      >
        ‚Äπ
      </button>

      <div class="categories-filter-mobile" #categoriesContainerMobile>
        <button
          (click)="selectedCategory = ''"
          [class.active]="selectedCategory === ''"
          class="category-btn"
        >
          Todos
        </button>
        <button
          *ngFor="let category of categories"
          (click)="selectedCategory = category.id"
          [class.active]="selectedCategory === category.id"
          class="category-btn"
        >
          <span [innerHTML]="category.icon"></span>
          {{ category.name }}
        </button>
      </div>

      <button
        class="category-scroll-btn-mobile category-scroll-right-mobile"
        (click)="scrollCategoriesMobile('right')"
        [disabled]="!canScrollRightMobile"
      >
        ‚Ä∫
      </button>
    </div>

    <!-- Products Grid -->
    <div class="products-grid-mobile">
      <div
        *ngFor="let product of getFilteredProducts()"
        [attr.data-product-id]="product.id"
        (click)="addToCart(product)"
        class="product-card"
      >
        <h4 class="product-name">{{ product.name }}</h4>
        <p class="product-price">R$ {{ product.price.toFixed(2) }}</p>
      </div>

      <div *ngIf="getFilteredProducts().length === 0" class="empty-products">
        <p>Nenhum produto encontrado</p>
      </div>
    </div>

    <!-- Cart Fixed Bottom -->
    <div class="cart-fixed-bottom" *ngIf="cartItems.length > 0">
      <div class="cart-items-compact">
        <div *ngFor="let item of cartItems" class="cart-item-compact">
          <span class="item-name">{{ item.product_name }}</span>
          <div class="item-controls">
            <button (click)="decreaseQuantity(item)" class="qty-btn">‚àí</button>
            <span class="qty-display">{{ item.quantity }}</span>
            <button (click)="increaseQuantity(item)" class="qty-btn">+</button>
          </div>
          <span class="item-total">R$ {{ (item.quantity * item.unit_price).toFixed(2) }}</span>
        </div>
      </div>
      <div class="cart-footer-mobile">
        <div class="cart-total">
          <span class="total-label">Total:</span>
          <span class="total-value">R$ {{ cartTotal.toFixed(2) }}</span>
        </div>
        <button (click)="submitAddItems()" class="submit-btn">
          Adicionar √† Comanda
        </button>
      </div>
    </div>
  </div>
</ng-template>

<!-- Receipt Component -->
<app-receipt
  *ngIf="selectedOrderForReceipt"
  [order]="selectedOrderForReceipt"
  (close)="onReceiptClose()"
  (finalize)="finalizeOrder($event)"
></app-receipt>

